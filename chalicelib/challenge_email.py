import os

from jinja2 import Environment, FileSystemLoader

from chalicelib.challenge import Challenge
from chalicelib.utils import send_email


class ChallengeEmail:
    @staticmethod
    def send_email(challenge: Challenge, csv_bytes: bytes):
        env = Environment(loader=FileSystemLoader('chalicelib/templates/'))
        template = env.get_template('challenge_email_template.html')
        html = template.render(
            total_balance=challenge.total_balance(),
            num_transactions=list(challenge.count_transaction_by_month().items()),
            avg_debit=challenge.average_debit_amount(),
            avg_credit=challenge.average_credit_amount(),
            image_url='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTU0IiBoZWlnaHQ9IjQ4IiB2aWV3Qm94PSIwIDAgMTU0IDQ4IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cGF0aCBkPSJNNTQuOTc5MiAzNi44MjQxQzU0Ljk3OTIgMzYuMjUzNiA1NS4xMzQ5IDM1LjczNDggNTUuNDk4IDM1LjIxNjFDNTUuODYxIDM0LjY5NzQgNTYuMjc2IDM0LjQzODEgNTYuNzk0NyAzNC40MzgxQzU3LjE1NzggMzQuNDM4MSA1Ny42MjQ2IDM0LjY5NzQgNTguMjQ3MSAzNS4yMTYxQzU4Ljg2OTUgMzUuNzM0OCA1OS44MDMyIDM2LjI1MzYgNjAuOTk2MiAzNi43NzIzQzYyLjE4OTMgMzcuMjkxIDYzLjU4OTggMzcuNTUwMyA2NS4xOTc3IDM3LjU1MDNDNjcuMzI0NCAzNy41NTAzIDY4Ljg4MDYgMzcuMTg3MiA2OS44MTQyIDM2LjQwOTJDNzAuNzQ3OSAzNS42MzExIDcxLjI2NjYgMzQuNjQ1NiA3MS4yNjY2IDMzLjUwNDRDNzEuMjY2NiAzMi4xMDM5IDcwLjc0NzkgMzAuOTYyOCA2OS42NTg2IDMwLjEzMjhDNjguNTY5MyAyOS4zMDI5IDY3LjI3MjYgMjguNjgwNSA2NS43NjgzIDI4LjIxMzZDNjQuMjEyMiAyNy43OTg3IDYyLjcwOCAyNy4zMzE4IDYxLjE1MTggMjYuODEzMUM1OS41OTU3IDI2LjI5NDQgNTguMjk5IDI1LjQxMjYgNTcuMjYxNiAyNC4yMTk2QzU2LjIyNDEgMjMuMDI2NiA1NS42NTM2IDIxLjQxODYgNTUuNjUzNiAxOS40NDc1QzU1LjY1MzYgMTcuMDYxNSA1Ni41MzU0IDE0Ljk4NjYgNTguMjQ3MSAxMy4yMjNDNTkuOTU4OCAxMS40NTk0IDYyLjYwNDIgMTAuNTc3NiA2Ni4xMzE0IDEwLjU3NzZDNjguMzYxOCAxMC41Nzc2IDcwLjQzNjcgMTAuOTQwNyA3Mi4zMDQgMTEuNjE1Qzc0LjE3MTQgMTIuMjg5NCA3NS4xMDUgMTMuMDY3NCA3NS4xMDUgMTMuOTQ5MkM3NS4xMDUgMTQuNDY3OSA3NC44OTc1IDE1LjAzODUgNzQuNDgyNiAxNS42NjFDNzQuMDY3NiAxNi4yODM0IDczLjYwMDggMTYuNTk0NiA3Mi45NzgzIDE2LjU5NDZDNzIuODIyNyAxNi41OTQ2IDcxLjk5MjggMTYuMjgzNCA3MC41NDA0IDE1LjY2MUM2OS4wODggMTUuMDM4NSA2Ny42MzU3IDE0LjcyNzMgNjYuMTgzMyAxNC43MjczQzY0LjIxMjIgMTQuNzI3MyA2Mi43NTk4IDE1LjE5NDEgNjEuODI2MiAxNi4xMjc4QzYwLjg5MjUgMTcuMDYxNSA2MC4zNzM4IDE4LjA5ODkgNjAuMzczOCAxOS4yNEM2MC4zNzM4IDIwLjQzMyA2MC44OTI1IDIxLjM2NjcgNjEuOTgxOCAyMi4wOTI5QzYzLjAxOTIgMjIuNzY3MiA2NC4zNjc4IDIzLjMzNzggNjUuOTIzOSAyMy43MDA5QzY3LjQ4IDI0LjA2NCA2OS4wMzYyIDI0LjU4MjcgNzAuNTQwNCAyNS4xMDE0QzcyLjA5NjUgMjUuNjcyIDczLjM5MzMgMjYuNjA1NiA3NC40MzA3IDI3Ljk1NDNDNzUuNDY4MSAyOS4zMDI5IDc2LjAzODcgMzEuMDY2NSA3Ni4wMzg3IDMzLjE5MzJDNzYuMDM4NyAzNS43ODY3IDc1LjEwNSAzNy44NjE1IDczLjIzNzcgMzkuMzY1OEM3MS4zNzAzIDQwLjg3IDY4LjcyNDkgNDEuNjQ4MSA2NS40MDUyIDQxLjY0ODFDNjIuNTAwNSA0MS42NDgxIDYwLjA2MjYgNDEuMTI5NCA1Ny45ODc3IDQwLjA5MkM1NS45NjQ4IDM5LjA1NDYgNTQuOTc5MiAzNy45NjUzIDU0Ljk3OTIgMzYuODI0MVoiIGZpbGw9IiMzODQ5NjciLz4KPHBhdGggZD0iTTgwLjEzNjQgMzEuNTMzM1YzLjQxOTQ3QzgwLjEzNjQgMi45MDA3NyA4MC4zOTU3IDIuNDg1OCA4MC45NjYzIDIuMTIyNzFDODEuNTM2OSAxLjc1OTYyIDgyLjEwNzQgMS42MDQgODIuNzI5OSAxLjYwNEM4My40MDQyIDEuNjA0IDg0LjAyNjYgMS44MTE0OSA4NC41OTcyIDIuMTIyNzFDODUuMTY3OCAyLjQ4NTggODUuNDI3MSAyLjkwMDc3IDg1LjQyNzEgMy40MTk0N1YxMC44ODg4SDkzLjQ2NzFDOTMuOTMzOSAxMC44ODg4IDk0LjI5NyAxMS4wOTYzIDk0LjYwODIgMTEuNTExM0M5NC45MTk1IDExLjkyNjIgOTUuMDc1MSAxMi40NDQ5IDk1LjA3NTEgMTIuOTYzN0M5NS4wNzUxIDEzLjUzNDIgOTQuOTE5NSAxNC4wMDExIDk0LjYwODIgMTQuNDE2Qzk0LjI5NyAxNC44MzEgOTMuOTMzOSAxNS4wMzg1IDkzLjQ2NzEgMTUuMDM4NUg4NS40MjcxVjMxLjM3NzdDODUuNDI3MSAzMy4xOTMyIDg1Ljg0MjEgMzQuNDg5OSA4Ni42MjAyIDM1LjIxNjFDODcuMzk4MiAzNS45NDIzIDg4Ljc5ODcgMzYuMzA1NCA5MC43MTc5IDM2LjMwNTRIOTIuNjg5QzkzLjQxNTIgMzYuMzA1NCA5My45ODU4IDM2LjUxMjkgOTQuNDAwOCAzNi45Nzk3Qzk0LjgxNTcgMzcuNDQ2NiA5NS4wMjMyIDM4LjAxNzEgOTUuMDIzMiAzOC42OTE0Qzk1LjAyMzIgMzkuMzY1OCA5NC44MTU3IDM5LjkzNjMgOTQuNDAwOCA0MC40MDMyQzkzLjk4NTggNDAuODcgOTMuNDE1MiA0MS4xMjk0IDkyLjc0MDkgNDEuMTI5NEg5MC43Njk4QzgzLjY2MzUgNDEuMTgxMiA4MC4xMzY0IDM3Ljk2NTMgODAuMTM2NCAzMS41MzMzWiIgZmlsbD0iIzM4NDk2NyIvPgo8cGF0aCBkPSJNOTYuOTQyNCAyOS4zMDNWMjIuNzY3M0M5Ni45NDI0IDE5LjQ5OTUgOTguMTg3MyAxNi42NDY2IDEwMC42NzcgMTQuMjA4N0MxMDMuMTY3IDExLjc3MDggMTA2LjEyMyAxMC41MjU5IDEwOS40OTUgMTAuNTI1OUMxMTIuODY3IDEwLjUyNTkgMTE1Ljg3NSAxMS43MTg5IDExOC4zNjUgMTQuMTU2OEMxMjAuODU1IDE2LjU5NDcgMTIyLjE1MSAxOS40NDc2IDEyMi4xNTEgMjIuNzY3M1YyOS4zMDNDMTIyLjE1MSAzMi41MTkgMTIwLjkwNyAzNS40MjM3IDExOC4zNjUgMzcuOTEzNUMxMTUuODIzIDQwLjQwMzMgMTEyLjg2NyA0MS43MDAxIDEwOS41NDcgNDEuNzAwMUMxMDYuMTc1IDQxLjcwMDEgMTAzLjI3MSA0MC40NTUyIDEwMC43MjkgMzcuOTY1NEM5OC4xODczIDM1LjQyMzcgOTYuOTQyNCAzMi41NzA5IDk2Ljk0MjQgMjkuMzAzWk0xMDIuMjMzIDI5LjI1MTFDMTAyLjIzMyAzMS4yMjIyIDEwMi45NTkgMzIuOTg1OCAxMDQuNDEyIDM0LjU0MTlDMTA1Ljg2NCAzNi4wNDYyIDEwNy41NzYgMzYuODI0MiAxMDkuNDk1IDM2LjgyNDJDMTExLjUxOCAzNi44MjQyIDExMy4yMyAzNi4wNDYyIDExNC42ODIgMzQuNDkwMUMxMTYuMTM0IDMyLjkzNCAxMTYuODYxIDMxLjIyMjIgMTE2Ljg2MSAyOS4yNTExVjIyLjgxOTJDMTE2Ljg2MSAyMC45IDExNi4xMzQgMTkuMTg4MyAxMTQuNjgyIDE3LjY4NEMxMTMuMjMgMTYuMTc5OCAxMTEuNTE4IDE1LjQwMTcgMTA5LjQ5NSAxNS40MDE3QzEwNy40NzIgMTUuNDAxNyAxMDUuNzYgMTYuMTc5OCAxMDQuMzYgMTcuNjg0QzEwMi45MDcgMTkuMTg4MyAxMDIuMjMzIDIwLjkgMTAyLjIzMyAyMi44MTkyVjI5LjI1MTFaIiBmaWxsPSIjMzg0OTY3Ii8+CjxwYXRoIGQ9Ik0xMjcuMTMxIDM5LjI2MjJWMTIuNzU2M0MxMjcuMTMxIDEyLjE4NTcgMTI3LjM5IDExLjc3MDggMTI3Ljg1NyAxMS40MDc3QzEyOC4zMjQgMTEuMDQ0NiAxMjguOTk4IDEwLjg4OSAxMjkuNzI1IDEwLjg4OUMxMzAuMzk5IDEwLjg4OSAxMzAuOTcgMTEuMDQ0NiAxMzEuNDM2IDExLjQwNzdDMTMxLjkwMyAxMS43NzA4IDEzMi4xNjMgMTIuMTg1NyAxMzIuMTYzIDEyLjc1NjNWMTUuODE2N0MxMzIuOTQxIDE0LjM2NDMgMTM0LjAzIDEzLjExOTQgMTM1LjUzNCAxMi4wODJDMTM3LjAzOCAxMS4wNDQ2IDEzOC42OTggMTAuNTI1OSAxNDAuNTE0IDEwLjUyNTlIMTQyLjY5MkMxNDMuMjYzIDEwLjUyNTkgMTQzLjczIDEwLjc4NTIgMTQ0LjE0NSAxMS4yNTIxQzE0NC41NiAxMS43NzA4IDE0NC43NjcgMTIuMzQxMyAxNDQuNzY3IDEyLjk2MzhDMTQ0Ljc2NyAxMy41ODYyIDE0NC41NiAxNC4xNTY4IDE0NC4xNDUgMTQuNjIzN0MxNDMuNzMgMTUuMDkwNSAxNDMuMjYzIDE1LjM0OTggMTQyLjY5MiAxNS4zNDk4SDE0MC41MTRDMTM4LjMzNSAxNS4zNDk4IDEzNi40NjggMTYuMjMxNiAxMzQuODYgMTcuOTQzNEMxMzMuMjUyIDE5LjcwNyAxMzIuNDIyIDIxLjkzNzQgMTMyLjQyMiAyNC42ODY1VjM5LjIxMDNDMTMyLjQyMiAzOS42NzcxIDEzMi4xNjMgNDAuMDkyMSAxMzEuNjQ0IDQwLjUwNzFDMTMxLjEyNSA0MC45MjIgMTMwLjUwMyA0MS4xMjk1IDEyOS43NzcgNDEuMTI5NUMxMjkuMDUgNDEuMTI5NSAxMjguNDI4IDQwLjkyMiAxMjcuOTA5IDQwLjU1ODlDMTI3LjMzOSA0MC4xOTU4IDEyNy4xMzEgMzkuNzI5IDEyNy4xMzEgMzkuMjYyMloiIGZpbGw9IiMzODQ5NjciLz4KPHBhdGggZD0iTTE0OC40NSA2LjY4NzQzQzE0Ny43NzYgNi4wNjQ5OCAxNDcuNDY0IDUuMzM4OCAxNDcuNDY0IDQuNTYwNzRDMTQ3LjQ2NCAzLjczMDgxIDE0Ny43NzYgMy4wNTY0OSAxNDguMzk4IDIuNDM0MDVDMTQ5LjAyIDEuODYzNDcgMTQ5Ljc5OSAxLjU1MjI1IDE1MC43ODQgMS41NTIyNUMxNTEuNjY2IDEuNTUyMjUgMTUyLjQ0NCAxLjg2MzQ3IDE1My4wNjYgMi40MzQwNUMxNTMuNjg5IDMuMDA0NjIgMTU0IDMuNzMwODEgMTU0IDQuNTYwNzRDMTU0IDUuMzkwNjcgMTUzLjY4OSA2LjA2NDk4IDE1My4wNjYgNi42ODc0M0MxNTIuNDQ0IDcuMzA5ODggMTUxLjY2NiA3LjYyMTEgMTUwLjc4NCA3LjYyMTFDMTQ5LjkwMiA3LjYyMTEgMTQ5LjEyNCA3LjMwOTg4IDE0OC40NSA2LjY4NzQzWk0xNDguMTM5IDM5LjI2MjFWMTIuNzU2M0MxNDguMTM5IDEyLjE4NTcgMTQ4LjM5OCAxMS43NzA3IDE0OC45MTcgMTEuNDA3NkMxNDkuNDM1IDExLjA0NDYgMTUwLjA1OCAxMC44ODg5IDE1MC43ODQgMTAuODg4OUMxNTEuNTYyIDEwLjg4ODkgMTUyLjE4NSAxMS4wNDQ2IDE1Mi43MDMgMTEuNDA3NkMxNTMuMjIyIDExLjc3MDcgMTUzLjQ4MSAxMi4xODU3IDE1My40ODEgMTIuNzU2M1YzOS4yNjIxQzE1My40ODEgMzkuNzI5IDE1My4yMjIgNDAuMTQzOSAxNTIuNzAzIDQwLjU1ODlDMTUyLjE4NSA0MC45NzM5IDE1MS41NjIgNDEuMTgxMyAxNTAuODM2IDQxLjE4MTNDMTUwLjExIDQxLjE4MTMgMTQ5LjQ4NyA0MC45NzM5IDE0OC45NjkgNDAuNjEwOEMxNDguMzk4IDQwLjE5NTggMTQ4LjEzOSAzOS43MjkgMTQ4LjEzOSAzOS4yNjIxWiIgZmlsbD0iIzM4NDk2NyIvPgo8cGF0aCBkPSJNMjguNjI4OSAzLjYyNzAyQzI5Ljc3MDEgNi41ODM2NCAyOC4zMTc3IDkuOTU1MjIgMjUuMzYxMSAxMS4wOTY0TDguNDUxMjcgMTcuNzg3N0M1LjQ5NDY1IDE4LjkyODggMi4xNzQ5MyAxNy40NzY1IDAuOTgxOTExIDE0LjUxOThDLTAuMjExMTExIDExLjU2MzIgMS4yOTMxMyA4LjE5MTYzIDQuMjQ5NzYgNy4wNTA0N0wyMS4xNTk2IDAuNDExMDQzQzI0LjExNjIgLTAuNzgxOTc5IDI3LjQ4NzggMC43MjIyNjYgMjguNjI4OSAzLjYyNzAyWiIgZmlsbD0iIzAwRjVFQiIvPgo8cGF0aCBkPSJNMTIuNTQ5MSA0My45MzA1QzExLjQwNzkgNDAuOTczOCAxMi44NjAzIDM3LjYwMjMgMTUuODE2OSAzNi40NjExTDMyLjcyNjcgMjkuODIxN0MzNS42ODM0IDI4LjY4MDUgMzkuMDU1IDMwLjEzMjkgNDAuMTk2MSAzMy4wODk1QzQxLjMzNzMgMzYuMDQ2MSAzOS44ODQ5IDM5LjQxNzcgMzYuOTI4MyA0MC41NTg5TDIwLjAxODUgNDcuMTQ2NEMxNy4xMTM3IDQ4LjMzOTUgMTMuNzQyMSA0Ni44MzUyIDEyLjU0OTEgNDMuOTMwNVoiIGZpbGw9IiNGRjhDRDkiLz4KPHBhdGggZD0iTTAuOTgxODM5IDE0LjUxOTlDMi4xMjI5OSAxNy40NzY1IDUuNDk0NTggMTguOTI4OSA4LjQ1MTIgMTcuNzg3N0w5Ljg1MTcgMTcuMjY5QzkuNjQ0MjIgMTYuOTA1OSA5LjQzNjc0IDE2LjQ5MDkgOS4yODExMyAxNi4wNzZDNy4yMDYzMSAxMC43ODUyIDkuNzk5ODMgNC44NzE5NCAxNS4wMzg4IDIuNzk3MTJMNC4yNDk2OCA3LjA1MDVDMS4yOTMwNiA4LjE5MTY2IC0wLjE1OTMxMyAxMS41NjMyIDAuOTgxODM5IDE0LjUxOTlaIiBmaWxsPSIjNzhBQ0Y4Ii8+CjxwYXRoIGQ9Ik0zMS45NDg3IDMxLjUzMzVDMzQuMDIzNSAzNi43NzI0IDMxLjQzIDQyLjczNzYgMjYuMTkxIDQ0Ljc2MDVMMzYuOTgwMSA0MC41MDcxQzM5LjkzNjcgMzkuMzY2IDQxLjM4OTEgMzUuOTk0NCA0MC4yNDggMzMuMDM3OEMzOS4xMDY4IDMwLjA4MTEgMzUuNzM1MiAyOC42Mjg4IDMyLjc3ODYgMjkuNzY5OUwzMS4zNzgxIDMwLjI4ODZDMzEuNTg1NiAzMC43MDM2IDMxLjc5MzEgMzEuMTE4NiAzMS45NDg3IDMxLjUzMzVaIiBmaWxsPSIjQkE2QkVCIi8+CjxwYXRoIGQ9Ik00MC4wOTIzIDI3LjUzOTNDMzguNjkxOCAyNC42ODY0IDM3LjE4NzYgMjMuMjg1OSAzNC42OTc4IDIxLjc4MTdDMzMuMjk3MyAyMC45NTE3IDI3LjU5MTUgMTkuMTM2MyAyMS41NzQ1IDE3LjMyMDhDMTQuNTcyIDE1LjE0MjIgNi42ODc2OCAxMi42NTI0IDUuMTgzNDMgMTEuOTI2M0MyLjMzMDU1IDEwLjYyOTUgMi4wNzEyIDguOTE3NzYgMy4wMDQ4NyA3Ljc3NjYxQy0wLjI2Mjk3NCA5Ljc5OTU2IC0wLjgzMzU1IDE2LjA3NTkgMS4xMzc1MyAyMC4xMjE4QzIuNTM4MDQgMjIuOTc0NyA0LjA0MjI4IDI0LjM3NTIgNi41MzIwNyAyNS44Nzk0QzcuOTMyNTcgMjYuNzA5NCAxMy42MzgzIDI4LjUyNDggMTkuNjU1MyAzMC4zNDAzQzI2LjY1NzggMzIuNTE4OSAzNC41NDIyIDM1LjA2MDUgMzYuMDQ2NCAzNS43MzQ4QzM4Ljg5OTMgMzcuMDMxNiAzOS4xNTg2IDM4Ljc0MzMgMzguMjI1IDM5Ljg4NDVDNDEuNDkyOCAzNy44NjE1IDQyLjA2MzQgMzEuNTg1MiA0MC4wOTIzIDI3LjUzOTNaIiBmaWxsPSIjQTlGRjk1Ii8+Cjwvc3ZnPgo='
        )

        send_email(
            subject="Prueba", body=html, to="anticris9303@gmail.com",
            smtp_server=os.getenv('SMTP_SERVER'),
            smtp_port=int(os.getenv('SMTP_PORT')),
            smtp_user=os.getenv('SMTP_USER'),
            smtp_password=os.getenv('SMTP_PASSWORD'),
            csv_bytes=csv_bytes
        )
